<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      th:replace="~{layout :: html(title='Ask a Question', content=~{::div}, styles=~{::head/link}, scripts=~{::head/script})}">
<head>
    <link rel="stylesheet" th:href="@{/css/ask-question.css}">
    <!-- SimpleMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <!-- Custom SimpleMDE styles to fix side-by-side layout -->
    <link rel="stylesheet" th:href="@{/css/simplemde-custom.css}">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the markdown editor
            var bodyEditor = new SimpleMDE({
                element: document.getElementById("bodyEditor"),
                spellChecker: false,
                autosave: {
                    enabled: true,
                    unique_id: "question_editor",
                },
                renderingConfig: {
                    codeSyntaxHighlighting: true,
                },
                toolbar: [
                    "bold", "italic", "heading", "|",
                    "code", "quote", "unordered-list", "ordered-list", "|",
                    "link", "image", "|",
                    "preview", "side-by-side", "fullscreen", "|",
                    "guide"
                ],
                placeholder: "Enter question details here...\n\n## What I've tried\n\n## Expected behavior\n\n## Actual behavior"
            });

            // Set initial content if empty
            if (!bodyEditor.value().trim()) {
                bodyEditor.value("Enter your question details here...");
            }

            // Immediately sync value to hidden field
            document.getElementById('body').value = bodyEditor.value();

            // Add input event listener to update hidden field when editor changes
            bodyEditor.codemirror.on("change", function() {
                document.getElementById('body').value = bodyEditor.value();
                console.log("Updated hidden field with:", bodyEditor.value());
            });

            // Double-check before submission that the hidden field is updated
            document.querySelector('form').addEventListener('submit', function(e) {
                // Prevent empty submissions
                if (!bodyEditor.value().trim()) {
                    e.preventDefault();
                    alert("Please enter details for your question");
                    return false;
                }

                // Force update the hidden field with editor content
                document.getElementById('body').value = bodyEditor.value();
                console.log("Form submitted with body:", document.getElementById('body').value);
                return true;
            });

            // Tag handling
            const tagInput = document.getElementById('tagInput');
            const tagContainer = document.getElementById('tagContainer');
            const tagsHidden = document.getElementById('tagsHidden');
            let tags = [];

            // Add tag when pressing Enter, comma, or space
            tagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',' || e.key === ' ') {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                }
            });

            // Add tag when input loses focus
            tagInput.addEventListener('blur', function() {
                if (this.value.trim()) {
                    addTag(this.value.trim());
                    this.value = '';
                }
            });

            // Function to add a tag
            function addTag(tag) {
                if (!tag || tags.includes(tag)) return;

                // Max 5 tags
                if (tags.length >= 5) {
                    alert('Maximum 5 tags allowed');
                    return;
                }

                tags.push(tag);
                updateTags();
            }

            // Remove tag when clicked
            tagContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('tag-remove')) {
                    const tagToRemove = e.target.parentElement.getAttribute('data-tag');
                    tags = tags.filter(tag => tag !== tagToRemove);
                    updateTags();
                }
            });

            // Update tags display and hidden input
            function updateTags() {
                tagContainer.innerHTML = '';
                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.setAttribute('data-tag', tag);
                    tagElement.innerHTML = tag + '<span class="tag-remove">&times;</span>';
                    tagContainer.appendChild(tagElement);
                });
                tagsHidden.value = tags.join(',');
            }

            // Add a default tag if none provided
            if (tags.length === 0) {
                addTag('java');
            }
        });
    </script>
</head>
<body>
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h1 class="mb-4">Ask a public question</h1>

                <div class="writing-tips card mb-4">
                    <div class="card-header">
                        Writing a good question
                    </div>
                    <div class="card-body">
                        <p>You're ready to <a href="#" target="_blank">ask</a> a programming-related question and this form will help guide you through the process.</p>
                        <p>Steps to write a good question:</p>
                        <ul>
                            <li>Summarize your problem in a one-line title</li>
                            <li>Describe your problem in more detail</li>
                            <li>Describe what you tried and what you expected to happen</li>
                            <li>Add "tags" which help surface your question to members of the community</li>
                            <li>Review your question and post it to the site</li>
                        </ul>
                    </div>
                </div>

                <form th:action="@{/questions/ask}" th:object="${question}" method="post" class="needs-validation" novalidate>
                    <!-- Title field -->
                    <div class="mb-4">
                        <div class="form-label-group">
                            <label for="title" class="form-label">Title</label>
                            <small class="form-text text-muted d-block mb-2">Be specific and imagine you're asking a question to another programmer</small>
                        </div>
                        <input type="text" class="form-control" id="title" name="title" th:field="*{title}"
                               placeholder="e.g. How to center a div with Flexbox?" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">
                            Please provide a title.
                        </div>
                    </div>

                    <!-- Body field -->
                    <div class="mb-4">
                        <div class="form-label-group">
                            <label for="bodyEditor" class="form-label">Body</label>
                            <small class="form-text text-muted d-block mb-2">Include all the information someone would need to answer your question</small>
                        </div>
                        <textarea id="bodyEditor" class="form-control" required></textarea>
                        <input type="hidden" id="body" name="body" th:field="*{body}">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('body')}" th:errors="*{body}">
                            Please provide details for your question.
                        </div>
                    </div>

                    <!-- Tags field -->
                    <div class="mb-4">
                        <div class="form-label-group">
                            <label for="tagInput" class="form-label">Tags</label>
                            <small class="form-text text-muted d-block mb-2">Add up to 5 tags to describe what your question is about (press Enter, comma, or space after each tag)</small>
                        </div>
                        <div class="tag-input-container">
                            <div id="tagContainer" class="tag-container"></div>
                            <input type="text" id="tagInput" class="form-control tag-input"
                                   placeholder="e.g. javascript, react, node.js">
                        </div>
                        <input type="hidden" id="tagsHidden" name="tags">
                    </div>

                    <!-- Submit button -->
                    <div class="d-grid gap-2 d-md-flex">
                        <button type="submit" class="btn btn-primary btn-lg">Post Your Question</button>
                        <a th:href="@{/questions}" class="btn btn-outline-secondary btn-lg">Discard</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
