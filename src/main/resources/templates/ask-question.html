<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <link rel="stylesheet" th:href="@{/css/ask-question.css}">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- SimpleMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <!-- Custom SimpleMDE styles to fix side-by-side layout -->
    <link rel="stylesheet" th:href="@{/css/simplemde-custom.css}">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <div th:fragment="content" class="ask-question-container">
        <div class="row">
            <div class="col-md-9">
                <div class="ask-question-header">
                    <h1 class="ask-question-title">Ask a Question</h1>
                    <p class="ask-question-subtitle">Get help from our community of developers</p>
                </div>

                <form th:action="@{/questions/ask}" th:object="${question}" method="post" id="questionForm">
                    <div class="question-form-card">
                        <div class="question-form-header">
                            <h5 class="question-form-title">Title</h5>
                        </div>
                        <div class="question-form-body">
                            <p class="question-form-guidance">Be specific and imagine you're asking a question to another person</p>
                            <input type="text" th:field="*{title}" class="question-form-input"
                                   placeholder="e.g. How to implement authentication in Spring Boot?"
                                   required minlength="10" maxlength="200">
                            <div class="error-text" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">Title error</div>
                        </div>
                    </div>

                    <div class="question-form-card">
                        <div class="question-form-header">
                            <h5 class="question-form-title">Body</h5>
                        </div>
                        <div class="question-form-body">
                            <p class="question-form-guidance">Include all the information someone would need to answer your question</p>

                            <div class="markdown-editor-container">
                                <textarea th:field="*{body}" id="bodyEditor" required></textarea>
                            </div>

                            <div class="error-text" th:if="${#fields.hasErrors('body')}" th:errors="*{body}">Body error</div>
                            <div class="form-help-text mt-2">
                                <i class="fas fa-info-circle"></i>
                                Supports Markdown. You can use <strong>bold</strong>, *italic*, code blocks, lists, and more.
                            </div>
                        </div>
                    </div>

                    <div class="question-form-card">
                        <div class="question-form-header">
                            <h5 class="question-form-title">Tags</h5>
                        </div>
                        <div class="question-form-body">
                            <p class="question-form-guidance">Add up to 5 tags to describe what your question is about</p>
                            <div class="tag-input-container" id="tagContainer">
                                <input type="text" id="tagInput" class="tag-input"
                                       placeholder="e.g. java spring-boot hibernate">
                            </div>
                            <input type="hidden" name="tags" id="tagsHidden" required>
                            <div class="form-help-text">
                                Add tags separated by space or comma (e.g., java spring-boot hibernate)
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <button type="submit" id="submitButton" class="question-submit-button">Post Your Question</button>
                    </div>
                </form>
            </div>

            <!-- Sidebar with FAQ/Tips -->
            <div class="col-md-3">
                <div class="tips-card">
                    <div class="tips-card-header">
                        Writing a Good Question
                    </div>
                    <div class="tips-card-body">
                        <div class="tips-title">Steps to write a great question:</div>
                        <ul class="tips-list">
                            <li>Summarize your problem in a one-line title</li>
                            <li>Describe your problem in more detail</li>
                            <li>Describe what you tried and what you expected</li>
                            <li>Include code samples, if relevant</li>
                            <li>Add tags that identify the languages or tools</li>
                            <li>Review and proofread before posting</li>
                        </ul>
                    </div>
                </div>

                <div class="tips-card">
                    <div class="tips-card-header">
                        Formatting Tips
                    </div>
                    <div class="tips-card-body">
                        <ul class="tips-list">
                            <li><code>**bold**</code> for <strong>bold text</strong></li>
                            <li><code>*italic*</code> for <em>italic text</em></li>
                            <li><code>`code`</code> for <code>inline code</code></li>
                            <li><code>```code block```</code> for code blocks</li>
                            <li><code>- item</code> for bullet lists</li>
                            <li><code>[link](url)</code> for hyperlinks</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize SimpleMDE Markdown Editor
            var simplemde = new SimpleMDE({
                element: document.getElementById("bodyEditor"),
                spellChecker: false,
                autofocus: true,
                placeholder: "Write your question details here...",
                toolbar: [
                    "bold", "italic", "heading", "|",
                    "code", "quote", "unordered-list", "ordered-list", "|",
                    "link", "image", "table", "|",
                    "preview", "side-by-side", "fullscreen", "|",
                    "guide"
                ],
                status: false,
                initialValue: document.getElementById("bodyEditor").value,
                renderingConfig: {
                    singleLineBreaks: false,
                    codeSyntaxHighlighting: true,
                }
            });

            // Initialize tag input
            const tagInput = document.getElementById('tagInput');
            const tagContainer = document.getElementById('tagContainer');
            const tagsHidden = document.getElementById('tagsHidden');
            const tags = new Set();

            function updateTags() {
                tagsHidden.value = Array.from(tags).join(',');
            }

            function addTag(tag) {
                if (!tag || tags.size >= 5) return;

                tag = tag.toLowerCase().trim();
                if (tag && !tags.has(tag)) {
                    tags.add(tag);

                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag-item';
                    tagElement.innerHTML = `
                        ${tag}
                        <button type="button" class="tag-item-remove">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

                    tagElement.querySelector('.tag-item-remove').addEventListener('click', function() {
                        tags.delete(tag);
                        tagElement.remove();
                        updateTags();
                    });

                    tagContainer.insertBefore(tagElement, tagInput);
                    updateTags();
                }

                tagInput.value = '';
            }

            tagInput.addEventListener('keydown', function(e) {
                if ((e.key === ' ' || e.key === ',' || e.key === 'Enter') && tagInput.value.trim()) {
                    e.preventDefault();
                    addTag(tagInput.value);
                }
            });

            // Enable side by side mode after editor loads
            setTimeout(function() {
                const sideButton = document.querySelector('.fa-columns');
                if (sideButton) {
                    sideButton.closest('button').click();
                }
            }, 500);

            // Form submission handling - using direct HTML form submission
            const form = document.getElementById('questionForm');

            // Override the form's submit event
            form.addEventListener('submit', function(e) {
                // Prevent default submission first
                e.preventDefault();

                // Make sure the SimpleMDE content is saved to the textarea
                simplemde.codemirror.save();

                // Validate tags
                if (!tagsHidden.value.trim()) {
                    alert('Please add at least one tag');
                    return false;
                }

                // If validation passes, submit the form
                this.submit();
            });
        });
    </script>
</body>
</html>
